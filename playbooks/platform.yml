---
# Platform: namespaces + optional Argo CD. Runs on control host (kubectl, KUBECONFIG, helm).
# Tags: namespaces, argocd. Make sets env_name from ENV; PATH and KUBECONFIG are set so kubectl/helm work.

- hosts: controlhost
  gather_facts: true
  become: false
  vars:
    env_name: "{{ env_name | default(env | default('localVM')) }}"
    # From group_vars is_ArgoCD_included; override with -e platform_install_argocd=false
    platform_install_argocd: "{{ is_ArgoCD_included | default(false) | bool }}"
    controlhost_path: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH | default('/usr/local/bin:/usr/bin:/bin') }}"
    controlhost_kubeconfig: "{{ ansible_env.HOME }}/.kube/config-{{ env_name }}"
  environment:
    PATH: "{{ controlhost_path }}"
    KUBECONFIG: "{{ controlhost_kubeconfig }}"
  roles:
    - namespaces
    - role: ansible_controlhost
      tags: [controlhost, argocd]   # ensures kubectl + helm in ~/.local/bin before Argo CD
    - argocd
  tags: [namespaces, argocd]
