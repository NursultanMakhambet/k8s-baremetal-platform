---
# Install kubectl on control host (Ansible host) and copy kubeconfig from first master.
# Plays: (1) controlhost = install kubectl; (2) first master = read config; (3) controlhost = write config.
# Tags: kubectl_config.
# Override kubectl_config_src in group_vars if your master uses a different path.
# Inventory must define group "controlhost" (e.g. controlhost ansible_connection=local).

- hosts: controlhost
  gather_facts: true
  become: false
  vars:
    env_name: "{{ env_name | default(env | default('localVM')) }}"
  roles:
    - ansible_host_kubectl_config
  tags: [kubectl_config]

# Read kubeconfig ON the first master (no delegate_to).
- hosts: kube_control_plane
  become: true
  gather_facts: false
  vars:
    env_name: "{{ env_name | default(env | default('localVM')) }}"
    # Path on master; override in group_vars if different (e.g. /etc/kubernetes/admin.conf)
    kubectl_config_src: /root/.kube/config
  tasks:
    - name: Read kubeconfig from first master (runs on master)
      shell: "sudo cat {{ kubectl_config_src }}"
      register: kubeconfig_content
      run_once: true
      tags: [kubectl_config]

# Write kubeconfig on control host using content from first master.
- hosts: controlhost
  become: false
  gather_facts: true
  vars:
    env_name: "{{ env_name | default(env | default('localVM')) }}"
    kubectl_config_dest: "{{ ansible_env.HOME }}/.kube/config-{{ env_name }}"
  tasks:
    - name: Write kubeconfig to control host
      copy:
        content: "{{ hostvars[groups['kube_control_plane'][0]]['kubeconfig_content']['stdout'] }}"
        dest: "{{ kubectl_config_dest }}"
        mode: "0600"
      when: hostvars[groups['kube_control_plane'][0]]['kubeconfig_content'] is defined
      tags: [kubectl_config]
