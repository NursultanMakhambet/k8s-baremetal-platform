---
# Only on hosts in group k8s. Tag: k8s (and firewall).

- name: Ensure firewalld is installed (RHEL/Rocky)
  package:
    name: firewalld
    state: present
  when: ansible_os_family == "RedHat" and inventory_hostname in groups.get('k8s', [])
  ignore_errors: true
  tags: [k8s, firewall]

- name: Start and enable firewalld
  service:
    name: firewalld
    state: started
    enabled: true
  when: ansible_os_family == "RedHat" and inventory_hostname in groups.get('k8s', [])
  ignore_errors: true
  tags: [k8s, firewall]

- name: Open required ports for etcd and Kubernetes
  firewalld:
    port: "{{ item.port }}"
    permanent: true
    state: enabled
    immediate: true
  loop: "{{ prepare_firewall_ports }}"
  when:
    - ansible_os_family == "RedHat"
    - inventory_hostname in groups.get('k8s', [])
    - prepare_firewall_ports is defined
  notify: reload firewalld
  tags: [k8s, firewall]

- name: Flush handlers (firewalld)
  meta: flush_handlers
  when: inventory_hostname in groups.get('k8s', [])
  tags: [k8s, firewall]
