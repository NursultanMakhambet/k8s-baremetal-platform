---
# Open ports for Postgres/DB on hosts in group 'db'. Tag: postgres (and firewall).

- name: Ensure firewalld is installed (RHEL/Rocky)
  package:
    name: firewalld
    state: present
  when: ansible_os_family == "RedHat" and inventory_hostname in groups.get('db', [])
  ignore_errors: true
  tags: [postgres, firewall]

- name: Start and enable firewalld
  service:
    name: firewalld
    state: started
    enabled: true
  when: ansible_os_family == "RedHat" and inventory_hostname in groups.get('db', [])
  ignore_errors: true
  tags: [postgres, firewall]

- name: Open required ports for Postgres
  firewalld:
    port: "{{ item.port }}"
    permanent: true
    state: enabled
    immediate: true
  loop: "{{ prepare_firewall_ports_postgres }}"
  when:
    - ansible_os_family == "RedHat"
    - inventory_hostname in groups.get('db', [])
    - prepare_firewall_ports_postgres is defined
  notify: reload firewalld
  tags: [postgres, firewall]

- name: Flush handlers (firewalld)
  meta: flush_handlers
  when: inventory_hostname in groups.get('db', [])
  tags: [postgres, firewall]
