---
# Argo CD: install via official manifest (no Helm hooks). Run on control host with kubectl, KUBECONFIG set.
# Only runs when platform_install_argocd is true. Override argocd_install_manifest_url in group_vars to pin a version.

- name: Install Argo CD in argocd namespace (manifest)
  command: >
    kubectl apply --server-side --force-conflicts -n argocd -f {{ argocd_install_manifest_url }}
  run_once: true
  when: platform_install_argocd | default(false) | bool
  tags: [argocd]

# Ensure argocd-secret has required keys so pods can start (CreateContainerConfigError fix).
- name: Check for htpasswd (for Argo CD admin password)
  command: which htpasswd
  register: argocd_htpasswd_check
  failed_when: false
  changed_when: false
  run_once: true
  when: platform_install_argocd | default(false) | bool
  tags: [argocd]

- name: Set htpasswd available fact
  set_fact:
    argocd_admin_password_htpasswd_available: "{{ argocd_htpasswd_check.rc == 0 }}"
  run_once: true
  when:
    - platform_install_argocd | default(false) | bool
    - argocd_htpasswd_check is defined
  tags: [argocd]

- name: Ensure argocd-secret has server.secretkey
  shell: |
    SECRETKEY=$(openssl rand -base64 32)
    kubectl patch secret argocd-secret -n argocd --type=merge -p "{\"stringData\":{\"server.secretkey\":\"$SECRETKEY\"}}"
  run_once: true
  when: platform_install_argocd | default(false) | bool
  tags: [argocd]

- name: Ensure argocd-secret has admin password (bcrypt; requires htpasswd)
  shell: |
    BCRYPT=$(htpasswd -nbBC 10 admin "{{ argocd_admin_password | default('admin') }}" | tr -d '\n' | sed 's/$2y/$2a/')
    MTIME=$(date +%FT%T%Z)
    kubectl patch secret argocd-secret -n argocd --type=merge -p "{\"stringData\":{\"admin.password\":\"$BCRYPT\",\"admin.passwordMtime\":\"$MTIME\"}}"
  run_once: true
  when:
    - platform_install_argocd | default(false) | bool
    - argocd_admin_password_htpasswd_available | default(false) | bool
  tags: [argocd]

# Pre-create argocd-redis secret so Redis main container has REDIS_PASSWORD.
- name: Ensure argocd-redis secret has auth key
  shell: |
    kubectl create secret generic argocd-redis -n argocd --from-literal=auth=$(openssl rand -base64 32) --dry-run=client -o yaml | kubectl apply -f -
  run_once: true
  when: platform_install_argocd | default(false) | bool
  tags: [argocd]

# Remove Redis init container when pods cannot reach API (e.g. "no route to host"). Secret is pre-created above.
- name: Remove argocd-redis init container (workaround for API unreachable from pod)
  shell: |
    kubectl patch deployment argocd-redis -n argocd --type=json -p='[{"op": "replace", "path": "/spec/template/spec/initContainers", "value": []}]'
  run_once: true
  when: platform_install_argocd | default(false) | bool
  tags: [argocd]
  register: argocd_redis_patch
  failed_when: false
  changed_when: argocd_redis_patch.rc == 0

- name: Restart Argo CD pods to pick up secret
  shell: |
    kubectl rollout restart statefulset -n argocd -l app.kubernetes.io/part-of=argocd
    kubectl rollout restart deployment -n argocd -l app.kubernetes.io/part-of=argocd
  run_once: true
  when: platform_install_argocd | default(false) | bool
  tags: [argocd]
