#!/usr/bin/env bash
set -e
cd "$(dirname "$0")"

VENV=.venv
VENV_BIN=$VENV/bin

# make
if ! command -v make >/dev/null 2>&1; then
  for c in apt-get dnf yum apk zypper; do
    command -v $c >/dev/null 2>&1 && { sudo $c update 2>/dev/null; sudo $c install -y make; break; } || true
  done
  command -v make >/dev/null 2>&1 || { echo "Install make"; exit 1; }
fi

[ -f "$VENV_BIN/activate" ] && [ -x "$VENV_BIN/ansible-playbook" ] && { echo "Venv exists. Run: make cluster"; exit 0; }

# Python 3.11/3.12 + build deps (ruamel.yaml.clib fails on 3.13)
if command -v apt-get >/dev/null 2>&1; then
  sudo apt-get update -qq 2>/dev/null || true
  sudo apt-get install -y build-essential 2>/dev/null || true
  for py in python3.11 python3.12; do
    if sudo apt-get install -y "$py" "${py}-venv" "${py}-dev" 2>/dev/null; then
      export PYTHON=$py
      break
    fi
  done
  [[ -z "${PYTHON:-}" ]] && { sudo apt-get install -y python3-venv python3-dev 2>/dev/null || true; export PYTHON=python3; }
fi

make bootstrap
echo "Done. Run: make cluster"
